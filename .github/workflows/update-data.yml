name: Update Trading Data

on:
  schedule:
    - cron: '*/15 * * * *'  # Alle 15 Minuten
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Fetch and process all strategies
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          AS2_EURUSD_M5_DB_ID: ${{ secrets.AS2_EURUSD_M5_DB_ID }}
          COT_N_DB_ID: ${{ secrets.COT_N_DB_ID }}
          STOCKS_DB_ID: ${{ secrets.STOCKS_DB_ID }}
        run: |
          python3 << 'EOF'
          import json
          import urllib.request
          import os
          from datetime import datetime

          def fetch_notion_data(database_id, api_key):
              """Fetch data from Notion database"""
              url = f'https://api.notion.com/v1/databases/{database_id}/query'
              headers = {
                  'Authorization': f'Bearer {api_key}',
                  'Notion-Version': '2022-06-28',
                  'Content-Type': 'application/json'
              }
              
              req = urllib.request.Request(url, method='POST', headers=headers)
              
              try:
                  with urllib.request.urlopen(req) as response:
                      return json.loads(response.read().decode())
              except Exception as e:
                  print(f"âŒ Error fetching data: {e}")
                  return None

          def calculate_stats(data):
              """Calculate wins, losses, and winrate"""
              wins = 0
              losses = 0
              
              if not data:
                  return {'wins': 0, 'losses': 0, 'total': 0, 'winrate': 0}
              
              for trade in data.get('results', []):
                  try:
                      outcome = trade.get('properties', {}).get('Outcome', {}).get('select', {}).get('name')
                      if outcome == 'Win':
                          wins += 1
                      elif outcome == 'Loss':
                          losses += 1
                  except:
                      continue
              
              total = wins + losses
              winrate = round(wins / total * 100, 1) if total > 0 else 0
              
              return {
                  'wins': wins,
                  'losses': losses,
                  'total': total,
                  'winrate': winrate,
                  'last_updated': datetime.utcnow().isoformat() + 'Z'
              }

          def save_json(filename, data):
              """Save data to JSON file"""
              os.makedirs('data', exist_ok=True)
              with open(f'data/{filename}', 'w') as f:
                  json.dump(data, f, indent=2)
              print(f"âœ… Saved {filename}: {data['wins']} wins, {data['losses']} losses, {data['winrate']}% winrate")

          # Get API key
          api_key = os.environ['NOTION_API_KEY']
          
          # Process AS-2 EURUSD M5
          if os.environ.get('AS2_EURUSD_M5_DB_ID'):
              print("ðŸ“Š Processing AS-2 EURUSD M5...")
              data = fetch_notion_data(os.environ['AS2_EURUSD_M5_DB_ID'], api_key)
              stats = calculate_stats(data)
              save_json('as2-eurusd-m5.json', stats)
          
          # Process COT-N
          if os.environ.get('COT_N_DB_ID'):
              print("ðŸ“Š Processing COT-N...")
              data = fetch_notion_data(os.environ['COT_N_DB_ID'], api_key)
              stats = calculate_stats(data)
              save_json('cot-n.json', stats)
          
          # Process Stocks
          if os.environ.get('STOCKS_DB_ID'):
              print("ðŸ“Š Processing Stocks...")
              data = fetch_notion_data(os.environ['STOCKS_DB_ID'], api_key)
              stats = calculate_stats(data)
              save_json('stocks.json', stats)
          
          print("âœ… All data updated successfully!")
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add data/*.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Update trading data"
          git push
