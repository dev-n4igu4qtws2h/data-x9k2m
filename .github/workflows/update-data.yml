name: Update Trading Data

on:
  schedule:
    - cron: '*/15 * * * *'  # Alle 15 Minuten
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Fetch and process all strategies
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          AS2_EURUSD_M5_DB_ID: ${{ secrets.AS2_EURUSD_M5_DB_ID }}
          COT_N_DB_ID: ${{ secrets.COT_N_DB_ID }}
          STOCKS_DB_ID: ${{ secrets.STOCKS_DB_ID }}
        run: |
          python3 << 'EOF'
          import json
          import urllib.request
          import os
          from datetime import datetime, timedelta

          def fetch_notion_data(database_id, api_key):
              """Fetch data from Notion database"""
              url = f'https://api.notion.com/v1/databases/{database_id}/query'
              headers = {
                  'Authorization': f'Bearer {api_key}',
                  'Notion-Version': '2022-06-28',
                  'Content-Type': 'application/json'
              }
              
              req = urllib.request.Request(url, method='POST', headers=headers)
              
              try:
                  with urllib.request.urlopen(req) as response:
                      return json.loads(response.read().decode())
              except Exception as e:
                  print(f"‚ùå Error fetching data: {e}")
                  return None

          def calculate_stats_with_timeframes(data):
              """Calculate stats for all timeframes"""
              
              if not data:
                  empty = {'wins': 0, 'losses': 0, 'total': 0, 'winrate': 0}
                  return {
                      'overall': empty,
                      'ytd': empty,
                      'this_month': empty,
                      'last_month': empty,
                      'last_week': empty,
                      'last_updated': datetime.utcnow().isoformat() + 'Z'
                  }
              
              now = datetime.utcnow()
              
              # Define timeframes
              ytd_start = datetime(now.year, 1, 1)
              this_month_start = datetime(now.year, now.month, 1)
              last_month_start = (this_month_start - timedelta(days=1)).replace(day=1)
              last_month_end = this_month_start - timedelta(seconds=1)
              last_week_start = now - timedelta(days=now.weekday() + 7)
              last_week_end = now - timedelta(days=now.weekday() + 1)
              
              def filter_and_count(trades, start=None, end=None):
                  """Filter trades by date range and count wins/losses"""
                  wins = 0
                  losses = 0
                  
                  for trade in trades:
                      try:
                          outcome = trade.get('properties', {}).get('Outcome', {}).get('select', {}).get('name')
                          
                          # Check date if Date column exists
                          if start or end:
                              date_prop = trade.get('properties', {}).get('Date', {})
                              if 'date' in date_prop and date_prop['date']:
                                  trade_date_str = date_prop['date'].get('start', '')
                                  if trade_date_str:
                                      # Parse ISO date
                                      trade_date = datetime.fromisoformat(trade_date_str.replace('Z', '+00:00').replace('+00:00', ''))
                                      
                                      if start and trade_date < start:
                                          continue
                                      if end and trade_date > end:
                                          continue
                          
                          if outcome == 'Win':
                              wins += 1
                          elif outcome == 'Loss':
                              losses += 1
                      except Exception as e:
                          # Skip trades with errors
                          continue
                  
                  total = wins + losses
                  winrate = round(wins / total * 100, 1) if total > 0 else 0
                  return {'wins': wins, 'losses': losses, 'total': total, 'winrate': winrate}
              
              results = data.get('results', [])
              
              # Calculate all timeframes
              stats = {
                  'overall': filter_and_count(results),
                  'ytd': filter_and_count(results, ytd_start),
                  'this_month': filter_and_count(results, this_month_start),
                  'last_month': filter_and_count(results, last_month_start, last_month_end),
                  'last_week': filter_and_count(results, last_week_start, last_week_end),
                  'last_updated': datetime.utcnow().isoformat() + 'Z'
              }
              
              return stats

          def save_json(filename, data):
              """Save data to JSON file"""
              os.makedirs('data', exist_ok=True)
              filepath = f'data/{filename}'
              with open(filepath, 'w') as f:
                  json.dump(data, f, indent=2)
              
              # Print summary
              if 'overall' in data:
                  overall = data['overall']
                  print(f"‚úÖ Saved {filename}:")
                  print(f"   Overall: {overall['wins']}W / {overall['losses']}L = {overall['winrate']}%")
                  if 'this_month' in data and data['this_month']['total'] > 0:
                      month = data['this_month']
                      print(f"   This Month: {month['wins']}W / {month['losses']}L = {month['winrate']}%")
              else:
                  print(f"‚úÖ Saved {filename}")

          # Get API key
          api_key = os.environ['NOTION_API_KEY']
          
          # Process AS-2 EURUSD M5
          if os.environ.get('AS2_EURUSD_M5_DB_ID'):
              print("üìä Processing AS-2 EURUSD M5...")
              data = fetch_notion_data(os.environ['AS2_EURUSD_M5_DB_ID'], api_key)
              if data:
                  stats = calculate_stats_with_timeframes(data)
                  save_json('as2-eurusd-m5.json', stats)
              else:
                  print("‚ö†Ô∏è No data fetched for AS-2 EURUSD M5")
          
          # Process COT-N
          if os.environ.get('COT_N_DB_ID'):
              print("üìä Processing COT-N...")
              data = fetch_notion_data(os.environ['COT_N_DB_ID'], api_key)
              if data:
                  stats = calculate_stats_with_timeframes(data)
                  save_json('cot-n.json', stats)
              else:
                  print("‚ö†Ô∏è No data fetched for COT-N")
          
          # Process Stocks
          if os.environ.get('STOCKS_DB_ID'):
              print("üìä Processing Stocks...")
              data = fetch_notion_data(os.environ['STOCKS_DB_ID'], api_key)
              if data:
                  stats = calculate_stats_with_timeframes(data)
                  save_json('stocks.json', stats)
              else:
                  print("‚ö†Ô∏è No data fetched for Stocks")
          
          print("‚úÖ All data updated successfully!")
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add data/*.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Update trading data"
          git push
