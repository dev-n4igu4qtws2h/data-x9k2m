name: Update Trading Data

on:
  schedule:
    - cron: '*/15 * * * *'  # Alle 15 Minuten
  workflow_dispatch:  # Manueller Trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests python-dateutil

      - name: Fetch and process all strategies
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          AS2_EURUSD_M5_DB_ID: ${{ secrets.AS2_EURUSD_M5_DB_ID }}
        run: |
          python3 << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime, timedelta
          from dateutil import parser

          def fetch_notion_data(database_id, api_key):
              url = f"https://api.notion.com/v1/databases/{database_id}/query"
              headers = {
                  "Authorization": f"Bearer {api_key}",
                  "Content-Type": "application/json",
                  "Notion-Version": "2022-06-28"
              }
              
              all_results = []
              has_more = True
              start_cursor = None
              
              while has_more:
                  payload = {}
                  if start_cursor:
                      payload["start_cursor"] = start_cursor
                  
                  response = requests.post(url, headers=headers, json=payload)
                  response.raise_for_status()
                  data = response.json()
                  
                  all_results.extend(data.get('results', []))
                  has_more = data.get('has_more', False)
                  start_cursor = data.get('next_cursor')
              
              return {'results': all_results}

          def get_trade_date(trade):
              """Extract trade date from 'Close Date / Time' or fallback to 'Date'"""
              date_prop = trade.get('properties', {}).get('Close Date / Time', {})
              
              if not date_prop or 'date' not in date_prop:
                  date_prop = trade.get('properties', {}).get('Date', {})
              
              if date_prop and 'date' in date_prop and date_prop['date']:
                  date_data = date_prop['date']
                  trade_date_str = date_data.get('start')
                  
                  if trade_date_str:
                      try:
                          clean_date = trade_date_str.split('T')[0]
                          return datetime.strptime(clean_date, '%Y-%m-%d')
                      except ValueError:
                          pass
              
              return None

          def get_profit(trade):
              """Extract Final Profit value"""
              profit_prop = trade.get('properties', {}).get('Final Profit', {})
              
              if profit_prop and 'number' in profit_prop:
                  return profit_prop['number']
              
              return None

          def calculate_equity_curve(trades, start_date=None, end_date=None):
              """Calculate equity curve data points with dates"""
              # Filter trades by date if specified
              filtered_trades = []
              for trade in trades:
                  trade_date = get_trade_date(trade)
                  if trade_date:
                      if start_date and trade_date < start_date:
                          continue
                      if end_date and trade_date > end_date:
                          continue
                      
                      profit = get_profit(trade)
                      if profit is not None:
                          filtered_trades.append({
                              'date': trade_date,
                              'profit': profit
                          })
              
              # Sort by date
              filtered_trades.sort(key=lambda x: x['date'])
              
              # Calculate cumulative equity
              equity_data = []
              cumulative = 0
              
              for trade in filtered_trades:
                  cumulative += trade['profit']
                  equity_data.append({
                      'date': trade['date'].strftime('%Y-%m-%d'),
                      'equity': round(cumulative, 2)
                  })
              
              return equity_data

          def process_strategy(database_id, api_key, strategy_name):
              print(f"\nProcessing {strategy_name}...")
              
              data = fetch_notion_data(database_id, api_key)
              trades = data.get('results', [])
              
              now = datetime.now()
              start_of_year = datetime(now.year, 1, 1)
              start_of_month = datetime(now.year, now.month, 1)
              
              if now.month == 1:
                  start_of_last_month = datetime(now.year - 1, 12, 1)
                  end_of_last_month = datetime(now.year, 1, 1) - timedelta(days=1)
              else:
                  start_of_last_month = datetime(now.year, now.month - 1, 1)
                  end_of_last_month = start_of_month - timedelta(days=1)
              
              start_of_week = now - timedelta(days=now.weekday())
              start_of_week = datetime(start_of_week.year, start_of_week.month, start_of_week.day)
              
              def calculate_stats(trade_list, start=None, end=None):
                  wins = 0
                  losses = 0
                  
                  for trade in trade_list:
                      trade_date = get_trade_date(trade)
                      if not trade_date:
                          continue
                      
                      if start and trade_date < start:
                          continue
                      if end and trade_date > end:
                          continue
                      
                      outcome_prop = trade.get('properties', {}).get('Outcome', {})
                      if outcome_prop and 'select' in outcome_prop and outcome_prop['select']:
                          outcome = outcome_prop['select']['name']
                          if outcome == 'Win':
                              wins += 1
                          elif outcome == 'Loss':
                              losses += 1
                  
                  total = wins + losses
                  winrate = round((wins / total * 100), 1) if total > 0 else 0
                  
                  return {
                      'wins': wins,
                      'losses': losses,
                      'total': total,
                      'winrate': winrate
                  }
              
              result = {
                  'overall': calculate_stats(trades),
                  'ytd': calculate_stats(trades, start_of_year),
                  'this_month': calculate_stats(trades, start_of_month),
                  'last_month': calculate_stats(trades, start_of_last_month, end_of_last_month),
                  'last_week': calculate_stats(trades, start_of_week),
                  'equity': {
                      'overall': calculate_equity_curve(trades),
                      'ytd': calculate_equity_curve(trades, start_of_year),
                      'this_month': calculate_equity_curve(trades, start_of_month),
                      'last_month': calculate_equity_curve(trades, start_of_last_month, end_of_last_month),
                      'last_week': calculate_equity_curve(trades, start_of_week)
                  },
                  'last_updated': datetime.utcnow().isoformat() + 'Z'
              }
              
              print(f"✅ {strategy_name}:")
              print(f"   Overall: {result['overall']['wins']}W / {result['overall']['losses']}L = {result['overall']['winrate']}%")
              print(f"   Equity points (Overall): {len(result['equity']['overall'])}")
              print(f"   YTD: {result['ytd']['wins']}W / {result['ytd']['losses']}L = {result['ytd']['winrate']}%")
              print(f"   This Month: {result['this_month']['wins']}W / {result['this_month']['losses']}L = {result['this_month']['winrate']}%")
              
              return result

          # Process AS2 EURUSD M5
          as2_data = process_strategy(
              os.environ['AS2_EURUSD_M5_DB_ID'],
              os.environ['NOTION_API_KEY'],
              'AS2 EURUSD M5'
          )

          # Save to JSON
          os.makedirs('data', exist_ok=True)
          
          with open('data/as2-eurusd-m5.json', 'w') as f:
              json.dump(as2_data, f, indent=2)
          
          print(f"\n✅ Saved as2-eurusd-m5.json")

          EOF

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/*.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update trading data [automated]" && git push)
