<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>AS-2 EURUSD M5 Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-primary: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --color-win: #3fb950;
            --color-loss: #f85149;
            --color-neutral: #58a6ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .timeframe-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .timeframe-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .timeframe-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--color-neutral);
        }

        .timeframe-btn.active {
            background: var(--color-neutral);
            color: white;
            border-color: var(--color-neutral);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 20px;
        }

        .card-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .gauge-container {
            height: 250px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-primary);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
        }

        .stat-value.win {
            color: var(--color-win);
        }

        .stat-value.loss {
            color: var(--color-loss);
        }

        .chart-container {
            width: 100%;
            margin-bottom: 20px;
        }

        .equity-card {
            grid-column: 1 / -1;
        }

        .equity-chart {
            height: 350px;
            margin-top: 15px;
        }

        .footer {
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-primary);
        }

        .signal-accuracy-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
            padding: 10px 0;
        }

        .signal-stat {
            flex: 1;
            text-align: center;
        }

        .signal-stat-label {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .signal-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .timeframe-buttons {
                gap: 8px;
            }
            
            .timeframe-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AS-2 EURUSD M5</h1>
            <p>Live Trading Dashboard</p>
        </div>

        <div class="timeframe-buttons">
            <button class="timeframe-btn active" data-timeframe="overall">Max</button>
            <button class="timeframe-btn" data-timeframe="ytd">YTD</button>
            <button class="timeframe-btn" data-timeframe="this_month">This Month</button>
            <button class="timeframe-btn" data-timeframe="last_month">Last Month</button>
            <button class="timeframe-btn" data-timeframe="last_week">Last Week</button>
        </div>

        <div class="stats-grid">
            <div class="card">
                <div class="card-title">Winrate</div>
                <div class="gauge-container">
                    <div id="gaugeChart"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Statistics</div>
                <div class="stat-row">
                    <span class="stat-label">Total Trades</span>
                    <span class="stat-value" id="totalTrades">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Winners</span>
                    <span class="stat-value win" id="winners">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Losers</span>
                    <span class="stat-value loss" id="losers">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Win Rate</span>
                    <span class="stat-value" id="winRate">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">W/L Ratio</span>
                    <span class="stat-value" id="wlRatio">-</span>
                </div>
            </div>
        </div>

        <div class="card" id="signalAccuracyCard" style="display: none;">
            <div class="card-title">Signal Accuracy</div>
            <div class="signal-accuracy-row">
                <div class="signal-stat">
                    <div class="signal-stat-label">Your Stats</div>
                    <div class="signal-stat-value" id="yourStats">-</div>
                </div>
                <div class="signal-stat">
                    <div class="signal-stat-label">Reference Signal Service</div>
                    <div class="signal-stat-value" id="refStats">-</div>
                </div>
                <div class="signal-stat">
                    <div class="signal-stat-label">Datafeed Diff</div>
                    <div class="signal-stat-value" id="datafeedDiff">-</div>
                </div>
                <div class="signal-stat">
                    <div class="signal-stat-label">Misdeeds</div>
                    <div class="signal-stat-value" id="missetaten">-</div>
                </div>
            </div>
        </div>

        <div class="card equity-card">
            <div class="card-title">Equity Curve</div>
            <div class="equity-chart">
                <div id="equityChart"></div>
            </div>
        </div>

        <div class="footer">
            <p>Last updated: <span id="lastUpdated">-</span></p>
            <p>Auto-refresh every 60 seconds</p>
        </div>
    </div>

    <script>
        let gaugeChart;
        let equityChart;
        let allData = null;
        let currentTimeframe = 'overall';

        // Initialize Gauge Chart
        function initGaugeChart() {
            const options = {
                series: [0],
                chart: {
                    type: 'radialBar',
                    height: 250,
                    background: 'transparent'
                },
                plotOptions: {
                    radialBar: {
                        startAngle: -135,
                        endAngle: 135,
                        hollow: {
                            size: '65%',
                        },
                        track: {
                            background: '#21262d',
                            strokeWidth: '100%',
                        },
                        dataLabels: {
                            name: {
                                fontSize: '14px',
                                color: '#8b949e',
                                offsetY: -10
                            },
                            value: {
                                fontSize: '32px',
                                color: '#c9d1d9',
                                offsetY: 5,
                                formatter: function(val) {
                                    return val.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'horizontal',
                        shadeIntensity: 0.5,
                        gradientToColors: ['#3fb950'],
                        inverseColors: false,
                        opacityFrom: 1,
                        opacityTo: 1,
                        stops: [0, 100]
                    }
                },
                stroke: {
                    lineCap: 'round'
                },
                labels: ['Win Rate'],
                theme: {
                    mode: 'dark'
                }
            };

            gaugeChart = new ApexCharts(document.querySelector("#gaugeChart"), options);
            gaugeChart.render();
        }

        // Initialize Equity Chart
        function initEquityChart() {
            const options = {
                series: [
                    { name: 'Profit', data: [] },
                    { name: 'Loss', data: [] }
                ],
                chart: {
                    type: 'area',
                    height: 350,
                    background: 'transparent',
                    toolbar: {
                        show: false
                    },
                    zoom: {
                        enabled: false
                    }
                },
                stroke: {
                    curve: 'monotoneCubic',
                    width: 1.5,
                    colors: ['#3fb950', '#f85149']
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'vertical',
                        shadeIntensity: 0.5,
                        inverseColors: false,
                        opacityFrom: 0.8,
                        opacityTo: 0.1,
                        stops: [0, 100]
                    }
                },
                colors: ['#3fb950', '#f85149'],
                markers: {
                    size: 0
                },
                dataLabels: {
                    enabled: false
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        style: {
                            colors: '#8b949e',
                            fontSize: '12px'
                        },
                        datetimeUTC: false
                    },
                    axisBorder: {
                        color: '#30363d'
                    },
                    axisTicks: {
                        color: '#30363d'
                    }
                },
                yaxis: {
                    forceNiceScale: true,
                    labels: {
                        style: {
                            colors: '#8b949e',
                            fontSize: '12px'
                        },
                        formatter: function(val) {
                            return '€' + val.toFixed(0);
                        }
                    }
                },
                annotations: {
                    yaxis: [{
                        y: 0,
                        borderColor: '#30363d',
                        strokeDashArray: 0,
                        borderWidth: 2,
                        opacity: 0.5
                    }]
                },
                grid: {
                    borderColor: '#30363d',
                    strokeDashArray: 3,
                    xaxis: {
                        lines: {
                            show: true
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                tooltip: {
                    theme: 'dark',
                    x: {
                        format: 'dd MMM yyyy'
                    },
                    y: {
                        formatter: function(val) {
                            return '€' + val.toFixed(2);
                        }
                    }
                },
                legend: {
                    show: false
                },
                theme: {
                    mode: 'dark'
                }
            };

            equityChart = new ApexCharts(document.querySelector("#equityChart"), options);
            equityChart.render();
        }

        // Update Dashboard
        function updateDashboard(timeframe) {
            if (!allData || !allData[timeframe]) return;

            const data = allData[timeframe];
            const equity = allData.equity[timeframe];

            // Update gauge
            gaugeChart.updateSeries([data.winrate]);

            // Update stats
            document.getElementById('totalTrades').textContent = data.total;
            document.getElementById('winners').textContent = data.wins;
            document.getElementById('losers').textContent = data.losses;
            document.getElementById('winRate').textContent = data.winrate.toFixed(1) + '%';
            
            const wlRatio = data.losses > 0 ? (data.wins / data.losses).toFixed(2) : data.wins;
            document.getElementById('wlRatio').textContent = wlRatio;

            // Update equity chart
            if (equity && equity.length > 0) {
                let aggregatedEquity;

                // Weekly aggregation for YTD and Overall, daily for shorter timeframes
                if (timeframe === 'overall' || timeframe === 'ytd') {
                    // Group by week (ISO week number)
                    const equityByWeek = {};
                    equity.forEach(point => {
                        const date = new Date(point.date);
                        const weekStart = new Date(date);
                        weekStart.setDate(date.getDate() - date.getDay() + 1); // Monday
                        const weekKey = weekStart.toISOString().split('T')[0];
                        equityByWeek[weekKey] = point.equity; // Last value of the week
                    });

                    aggregatedEquity = Object.entries(equityByWeek).map(([date, equity]) => ({
                        date: date,
                        equity: equity
                    }));
                } else {
                    // Daily aggregation for shorter timeframes
                    const equityByDay = {};
                    equity.forEach(point => {
                        equityByDay[point.date] = point.equity;
                    });

                    aggregatedEquity = Object.entries(equityByDay).map(([date, equity]) => ({
                        date: date,
                        equity: equity
                    }));
                }

                // Add starting point at €0 (one day before first trade)
                const firstDate = new Date(aggregatedEquity[0].date);
                const startDate = new Date(firstDate.getTime() - 24 * 60 * 60 * 1000); // 1 day before

                const allPoints = [
                    { x: startDate.getTime(), y: 0 },
                    ...aggregatedEquity.map(point => ({
                        x: new Date(point.date).getTime(),
                        y: point.equity
                    }))
                ];

                // Split into positive and negative series with interpolated zero crossings
                const profitData = [];
                const lossData = [];

                for (let i = 0; i < allPoints.length; i++) {
                    const point = allPoints[i];
                    const nextPoint = i < allPoints.length - 1 ? allPoints[i + 1] : null;

                    if (point.y >= 0) {
                        profitData.push([point.x, point.y]);
                        lossData.push([point.x, null]);

                        // Check if next point crosses into negative
                        if (nextPoint && nextPoint.y < 0) {
                            // Interpolate zero crossing point
                            const ratio = Math.abs(point.y) / (Math.abs(point.y) + Math.abs(nextPoint.y));
                            const crossX = point.x + (nextPoint.x - point.x) * ratio;
                            profitData.push([crossX, 0]);
                            lossData.push([crossX, 0]);
                        }
                    } else {
                        profitData.push([point.x, null]);
                        lossData.push([point.x, point.y]);

                        // Check if next point crosses into positive
                        if (nextPoint && nextPoint.y >= 0) {
                            // Interpolate zero crossing point
                            const ratio = Math.abs(point.y) / (Math.abs(point.y) + Math.abs(nextPoint.y));
                            const crossX = point.x + (nextPoint.x - point.x) * ratio;
                            profitData.push([crossX, 0]);
                            lossData.push([crossX, 0]);
                        }
                    }
                }

                equityChart.updateSeries([
                    { name: 'Profit', data: profitData },
                    { name: 'Loss', data: lossData }
                ]);
            } else {
                equityChart.updateSeries([
                    { name: 'Profit', data: [] },
                    { name: 'Loss', data: [] }
                ]);
            }

            // Update Signal Accuracy widget (only visible for last_month)
            const signalCard = document.getElementById('signalAccuracyCard');
            if (timeframe === 'last_month' && allData.signal_accuracy && allData.signal_accuracy.last_month) {
                signalCard.style.display = 'block';

                const ref = allData.signal_accuracy.last_month;

                // Your Stats
                document.getElementById('yourStats').textContent =
                    `${data.wins}W / ${data.losses}L`;

                // Reference Signal Service
                document.getElementById('refStats').textContent =
                    `${ref.reference_wins}W / ${ref.reference_losses}L`;

                // Datafeed Diff
                const diffElem = document.getElementById('datafeedDiff');
                diffElem.textContent = `${ref.datafeed_diff >= 0 ? '+' : ''}${ref.datafeed_diff}`;
                diffElem.style.color = ref.datafeed_diff >= 0 ? 'var(--color-win)' : 'var(--color-loss)';

                // Missetaten (discrepancies from expected)
                const missetaten = Math.abs(data.wins - ref.expected_wins) + Math.abs(data.losses - ref.expected_losses);
                const missetatenElem = document.getElementById('missetaten');
                missetatenElem.textContent = missetaten.toString();
                missetatenElem.style.color = missetaten === 0 ? 'var(--color-win)' : 'var(--color-loss)';
            } else {
                signalCard.style.display = 'none';
            }

            // Update timestamp
            if (allData.last_updated) {
                const date = new Date(allData.last_updated);
                document.getElementById('lastUpdated').textContent = date.toLocaleString('de-DE');
            }
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch('../../data/as2-eurusd-m5.json?t=' + Date.now());
                allData = await response.json();
                updateDashboard(currentTimeframe);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Timeframe button handlers
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTimeframe = this.dataset.timeframe;
                updateDashboard(currentTimeframe);
            });
        });

        // Initialize
        initGaugeChart();
        initEquityChart();
        loadData();

        // Auto-refresh every 60 seconds
        setInterval(loadData, 60000);
    </script>
</body>
</html>
